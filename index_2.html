<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEST VISTEC - Live Battery Monitor</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Base & Reset --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background-color: #ffffff; /* White background */
            color: #343a40; /* Dark gray for text */
            padding: 20px;
            min-height: 100vh;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px; /* Add padding for container */
        }

        /* --- Header --- */
        .header { text-align: center; margin-bottom: 35px; padding: 25px 20px; background-color: #ffffff; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .header h1 { font-size: 2.1em; margin-bottom: 8px; font-weight: 700; color: #20398c; }
        .header .subtitle { font-size: 1.1em; color: #495057; margin-bottom: 15px; }
        .version-badge { display: inline-block; background: #0d6efd; color: white; padding: 5px 12px; border-radius: 12px; font-weight: 600; font-size: 0.85em; margin-bottom: 15px; }
        .company-link { color: #20398c; text-decoration: none; font-size: 0.9em; font-weight: 600; transition: color 0.2s ease; }
        .company-link:hover { color: #1a2f70; text-decoration: underline; }

        /* --- Status Bar --- */
        .status-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .status-badge { padding: 8px 18px; border-radius: 18px; font-size: 0.85em; font-weight: 600; display: flex; align-items: center; gap: 7px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); border: 1px solid transparent; }
        .status-connected { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc;}
        .status-disconnected { background-color: #f8d7da; color: #842029; border-color: #f5c2c7;}
        .status-info { background-color: #e2e3e5; color: #41464b; border-color: #d3d6d8;}
        .live-dot { display: inline-block; width: 8px; height: 8px; background: #198754; border-radius: 50%; animation: pulse 1.8s infinite ease-in-out; }
        .status-disconnected .live-dot { display: none; }
        @keyframes pulse { 0%, 100% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }

        /* --- Update Counter --- */
        .update-counter { position: fixed; top: 15px; right: 15px; background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; padding: 8px 15px; border-radius: 6px; font-weight: 600; font-size: 0.9em; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); z-index: 1000; }

        /* --- Toolbar --- */
        .toolbar { background: #ffffff; border-radius: 8px; padding: 15px 20px; margin-bottom: 25px; display: flex; gap: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between; border: 1px solid #dee2e6; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .toolbar-section { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .toolbar label { color: #495057 !important; font-weight: 600; font-size: 0.9em; margin-bottom: 0; }
        .toolbar select, .custom-range input { padding: 8px 12px; border-radius: 6px; border: 1px solid #ced4da; background-color: #ffffff; color: #343a40; font-size: 0.9em; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        .toolbar select { cursor: pointer; }
        .toolbar select:focus, .custom-range input:focus { outline: 0; border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
        .custom-range { display: none; gap: 10px; flex-wrap: wrap; align-items: center; }
        .custom-range.active { display: flex; }
        .btn { padding: 8px 18px; border: none; border-radius: 6px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; user-select: none; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background-color: #6c757d; color: white; border: 1px solid #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }

        /* --- Metrics Grid --- */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .metric-card { background: #ffffff; border-radius: 8px; padding: 18px 15px; text-align: center; border: 1px solid #dee2e6; transition: all 0.2s ease; position: relative; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
        .metric-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(32, 57, 140, 0.08), transparent); transition: left 0.5s ease; }
        .metric-card.flash::before { left: 100%; }
        .metric-card:hover { transform: translateY(-4px); box-shadow: 0 5px 12px rgba(0, 0, 0, 0.08); border-color: #adb5bd;}
        .metric-label { font-size: 0.75em; color: #6c757d; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; }
        .metric-value { font-size: 1.8em; font-weight: 700; color: #212529; display: block; min-height: 40px; line-height: 40px; }
        .metric-unit { font-size: 0.9em; color: #495057; font-weight: 400; margin-left: 4px; }
        .metric-label > span { margin-right: 5px; }
        .status-charging { color: #198754; font-weight: 600; } .status-discharging { color: #ffc107; font-weight: 600; } .status-idle { color: #6c757d; font-weight: 600; }

        /* --- Charts Container --- */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: #ffffff; border-radius: 8px; padding: 25px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.06); }
        .chart-card h3 { margin-bottom: 20px; color: #20398c; font-size: 1.1em; font-weight: 600; }
        .chart-wrapper { position: relative; height: 300px; }

        /* --- Messages --- */
        .message-container { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 1000; max-width: 450px; width: 95%; }
        .error-message, .success-message { padding: 12px 20px; border-radius: 6px; margin-bottom: 10px; font-weight: 600; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; text-align: left; color: white; display: flex; align-items: center; gap: 10px;}
        .error-message::before { content: '‚ùå'; } .success-message::before { content: '‚úÖ'; }
        .error-message { background-color: #dc3545; border: 1px solid #b02a37; } .success-message { background-color: #198754; border: 1px solid #146c43; }
        @keyframes slideIn { from { transform: translateX(-50%) translateY(-60px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

        /* --- Debug Panel --- */
        .debug-panel { background: #e9ecef; border: 1px solid #dee2e6; color: #343a40; border-radius: 6px; padding: 15px; margin-top: 20px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap; display: none; max-height: 200px; overflow-y: auto; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) {
            .charts-container { grid-template-columns: 1fr; }
        }

        /* === MOBILE ADJUSTMENTS START === */
        @media (max-width: 768px) {
            body {
                padding: 5px; /* Reduce body padding */
            }
            .container {
                padding: 0 5px; /* Reduce container padding */
            }
            .header {
                padding: 15px 10px; /* Reduce header padding */
                margin-bottom: 20px; /* Reduce margin below header */
            }
            .header h1 {
                font-size: 1.5em; /* Smaller title */
            }
            .header .subtitle {
                font-size: 0.9em; /* Smaller subtitle */
                margin-bottom: 10px;
            }
            .status-bar {
                margin-bottom: 15px; /* Reduce margin */
                gap: 8px; /* Reduce gap */
            }
            .status-badge {
                padding: 5px 12px; /* Smaller badges */
                font-size: 0.75em;
            }
            .toolbar {
                padding: 10px; /* Reduce toolbar padding */
                margin-bottom: 20px;
                flex-direction: column; /* Stack toolbar sections */
                align-items: stretch; /* Stretch sections full width */
                gap: 10px; /* Adjust gap */
            }
             .toolbar-section {
                 justify-content: space-between; /* Space out items like label and select */
             }
            .toolbar-section:last-child {
                justify-content: center; /* Center refresh button */
            }
            .toolbar label, .toolbar select, .toolbar input, .btn {
               font-size: 0.8em; /* Smaller controls */
            }
            .btn {
                padding: 6px 12px;
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(125px, 1fr)); /* Allow smaller cards */
                gap: 8px; /* Reduce gap */
                margin-bottom: 20px;
            }
            .metric-card {
               padding: 12px 10px; /* Reduce card padding */
            }
            .metric-label {
                font-size: 0.7em; /* Smaller label */
                margin-bottom: 4px;
            }
            .metric-value {
                font-size: 1.4em; /* Smaller value */
                min-height: 30px;
                line-height: 30px;
            }
            .metric-unit {
                font-size: 0.75em; /* Smaller unit */
            }
            .charts-container {
                grid-template-columns: 1fr; /* Ensure single column */
                gap: 10px; /* Reduce gap */
                margin-bottom: 20px;
            }
            .chart-card {
                padding: 15px; /* Reduce card padding */
            }
            .chart-card h3 {
                font-size: 0.95em; /* Smaller chart title */
                margin-bottom: 10px;
            }
            .chart-wrapper {
                height: 220px; /* Significantly reduce chart height */
            }
             .message-container {
                 width: 90%;
             }
             .update-counter {
                 font-size: 0.85em; padding: 6px 12px;
             }
        }

        @media (max-width: 480px) {
             body { padding: 5px; }
             .container { padding: 0 5px;}
             .header h1 { font-size: 1.3em; }
             .header .subtitle { font-size: 0.8em; }
             .metrics-grid { grid-template-columns: repeat(2, 1fr); gap: 6px;} /* Force 2 columns */
             .metric-value { font-size: 1.3em;}
             .chart-wrapper { height: 200px; } /* Even smaller charts */
             .status-badge { padding: 4px 8px;} /* Even smaller badges */
             /* Hide less critical text in status badges on very small screens */
             .status-badge span:not(#statusText):not(#lastUpdate):not(#dataPoints) {
                /* Optionally hide elements like 'Last Update:' label, keep only value */
                /* Example: If you have <span class="label">Last Update:</span> <span id="lastUpdate">time</span> */
                /* You could hide the label span: .status-badge span.label { display: none; } */
             }
             .toolbar-section { flex-direction: column; align-items: stretch; gap: 8px; }
             .custom-range { flex-direction: column; align-items: stretch; }
             .custom-range label { margin-bottom: 2px; }
             .custom-range input { width: 100%; }
             .custom-range button { margin-top: 5px; }
        }
         /* === MOBILE ADJUSTMENTS END === */

    </style>
</head>
<body>
    <div id="updateCounter" class="update-counter"> Updates: <span id="updateCount">0</span> </div>
    <div class="message-container"> <div id="errorContainer"></div> <div id="successContainer"></div> </div>

    <div class="container">
        <div class="header">
            <h1><span style="font-size: 1.1em;">‚òÄÔ∏è</span> Solar Light Field Test Monitoring</h1>
            <p class="subtitle">Real-time CEST Battery Monitoring</p>
            <div class="version-badge"> LIVE DATA </div><br>
            <a href="https://www.cestvistec.com/" class="company-link" target="_blank" rel="noopener noreferrer"> üåê CEST VISTEC - Battery Technology Solutions </a>
        </div>

        <div class="status-bar"> <div id="statusBadge" class="status-badge status-disconnected"> <span id="liveDot" class="live-dot"></span> <span id="statusText">Connecting...</span> </div> <div class="status-badge status-info"> <span>Last Update:</span>&nbsp;<span id="lastUpdate">Waiting...</span> </div> <div class="status-badge status-info"> <span>Points:</span>&nbsp;<span id="dataPoints">0</span> </div> </div>
         <div id="toolbar" class="toolbar"> <div class="toolbar-section"> <label for="timeRangeSelect">Time Range:</label> <select id="timeRangeSelect" onchange="handleTimeRangeChange()"> <option value="5m">Last 5 Min</option> <option value="15m">Last 15 Min</option> <option value="30m">Last 30 Min</option> <option value="1h">Last 1 Hour</option> <option value="3h">Last 3 Hours</option> <option value="6h">Last 6 Hours</option> <option value="12h">Last 12 Hours</option> <option value="24h">Last 24 Hours</option> <option value="7d">Last 7 Days</option> <option value="custom">Custom</option> </select> <div id="customRange" class="custom-range"> <label for="startTime">From:</label> <input type="datetime-local" id="startTime"> <label for="endTime">To:</label> <input type="datetime-local" id="endTime"> <button class="btn btn-secondary" onclick="applyCustomRange()">Apply</button> </div> </div> <div class="toolbar-section"> <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button> </div> </div>
         <div id="metricsGrid" class="metrics-grid"> <div class="metric-card" id="card-voltage-filtered"> <div class="metric-label"><span>üîã</span> Voltage (Filtered)</div> <div class="metric-value"> <span id="voltageFiltered">--</span><span class="metric-unit">V</span> </div> </div> <div class="metric-card" id="card-voltage-raw"> <div class="metric-label"><span>üìä</span> Voltage (Raw)</div> <div class="metric-value"> <span id="voltageRaw">--</span><span class="metric-unit">V</span> </div> </div> <div class="metric-card" id="card-current"> <div class="metric-label"><span>‚ö°</span> Current</div> <div class="metric-value"> <span id="current">--</span><span class="metric-unit">mA</span> </div> </div> <div class="metric-card" id="card-power"> <div class="metric-label"><span>üí™</span> Power</div> <div class="metric-value"> <span id="power">--</span><span class="metric-unit">W</span> </div> </div> <div class="metric-card" id="card-soc"> <div class="metric-label"><span>üîã</span> State of Charge</div> <div class="metric-value"> <span id="soc">--</span><span class="metric-unit">%</span> </div> </div> <div class="metric-card" id="card-temp"> <div class="metric-label"><span>üå°Ô∏è</span> Temperature</div> <div class="metric-value"> <span id="temp">--</span><span class="metric-unit">¬∞C</span> </div> </div> <div class="metric-card" id="card-humidity"> <div class="metric-label"><span>üíß</span> Humidity</div> <div class="metric-value"> <span id="humidity">--</span><span class="metric-unit">%</span> </div> </div> <div class="metric-card" id="card-status"> <div class="metric-label"><span>üìà</span> Status</div> <div class="metric-value"> <span id="status">IDLE</span> </div> </div> <div class="metric-card" id="card-good"> <div class="metric-label"><span>‚úÖ</span> Good Readings</div> <div class="metric-value"> <span id="goodReadings">--</span> </div> </div> <div class="metric-card" id="card-bad"> <div class="metric-label"><span>‚ùå</span> Bad Readings</div> <div class="metric-value"> <span id="badReadings">--</span> </div> </div> </div>
         <div id="chartsContainer" class="charts-container"> <div class="chart-card"> <h3>üìä Voltage Monitoring</h3> <div class="chart-wrapper"> <canvas id="voltageChart"></canvas> </div> </div> <div class="chart-card"> <h3>‚ö° Current & Power</h3> <div class="chart-wrapper"> <canvas id="powerChart"></canvas> </div> </div> <div class="chart-card"> <h3>üîã State of Charge</h3> <div class="chart-wrapper"> <canvas id="socChart"></canvas> </div> </div> <div class="chart-card"> <h3>üå°Ô∏è Environmental Conditions</h3> <div class="chart-wrapper"> <canvas id="envChart"></canvas> </div> </div> </div>

        <div id="debugInfo" class="debug-panel"></div>
    </div>

    <script>
        // --- GLOBAL VARIABLES, DOM CACHE, INITIALIZATION, CACHE ELEMENTS, START MONITORING ---
        // --- TIME RANGE FUNCTIONS, CHART INITIALIZATION, DATA FETCHING, DATA PROCESSING ---
        // --- FORCE UPDATE VALUE, FLASH, STATUS/MESSAGES, CLEANUP ---
        // --- (All JavaScript functions remain exactly the same as the previous "Production Level" version) ---
        const config = { url: "https://us-east-1-1.aws.cloud2.influxdata.com", token: "fRjbZpkh28B7HIaqHyR4A62Jr2bGwiC8Hcc-LwaCUxtKojBMH39CscUEuqp9PTDuqab_3yEfFGtCtsdCYD52Fw==", org: "060e7983bb6be38e", bucket: "solar_bucket" };
        let updateInterval = null, charts = {}, currentTimeRange = '5m', rawDataCache = [], isUpdating = false, updateCounter = 0; let aggregateInterval = '5s'; const ui = {};
        window.addEventListener('load', () => { console.log('üöÄ CEST VISTEC Battery Monitor - Production v1.1'); cacheDOMElements(); startMonitoring(); });
        function cacheDOMElements() { ui.statusBadge = document.getElementById('statusBadge'); ui.statusText = document.getElementById('statusText'); ui.liveDot = document.getElementById('liveDot'); ui.lastUpdate = document.getElementById('lastUpdate'); ui.dataPoints = document.getElementById('dataPoints'); ui.errorContainer = document.getElementById('errorContainer'); ui.successContainer = document.getElementById('successContainer'); ui.timeRangeSelect = document.getElementById('timeRangeSelect'); ui.customRangeDiv = document.getElementById('customRange'); ui.startTimeInput = document.getElementById('startTime'); ui.endTimeInput = document.getElementById('endTime'); ui.updateCountSpan = document.getElementById('updateCount'); ui.voltageFiltered = document.getElementById('voltageFiltered'); ui.voltageRaw = document.getElementById('voltageRaw'); ui.current = document.getElementById('current'); ui.power = document.getElementById('power'); ui.soc = document.getElementById('soc'); ui.temp = document.getElementById('temp'); ui.humidity = document.getElementById('humidity'); ui.status = document.getElementById('status'); ui.goodReadings = document.getElementById('goodReadings'); ui.badReadings = document.getElementById('badReadings'); ui.voltageChartCanvas = document.getElementById('voltageChart'); ui.powerChartCanvas = document.getElementById('powerChart'); ui.socChartCanvas = document.getElementById('socChart'); ui.envChartCanvas = document.getElementById('envChart'); }
        function startMonitoring() { initCharts(); fetchData(); if (updateInterval) clearInterval(updateInterval); updateInterval = setInterval(() => { if (!isUpdating) fetchData(); }, 3000); console.log('‚úÖ Monitoring started - refreshing every 3 seconds'); }
        function handleTimeRangeChange() { currentTimeRange = ui.timeRangeSelect.value; if (currentTimeRange === 'custom') { ui.customRangeDiv.classList.add('active'); const now = new Date(), oneHourAgo = new Date(now - 3600000); ui.endTimeInput.value = formatDateTimeLocal(now); ui.startTimeInput.value = formatDateTimeLocal(oneHourAgo); } else { ui.customRangeDiv.classList.remove('active'); fetchData(); } } function applyCustomRange() { fetchData(); } function formatDateTimeLocal(date) { const pad = (n) => String(n).padStart(2, '0'); return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`; } function getTimeRangeQuery() { if (currentTimeRange === 'custom') { const start = ui.startTimeInput.value, end = ui.endTimeInput.value; if (!start || !end) { showError('Select start and end times'); return null; } return `range(start: ${new Date(start).toISOString()}, stop: ${new Date(end).toISOString()})`; } else { return `range(start: -${currentTimeRange})`; } } function refreshData() { clearError(); clearSuccess(); fetchData(); showSuccess('Data refreshed'); }
        function initCharts() { const chartOptions = { responsive: true, maintainAspectRatio: false, animation: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm', hour: 'MMM dd HH:mm', day: 'MMM dd' } }, ticks: { color: '#6c757d', maxTicksLimit: 10, font: {size: 10} }, grid: { color: 'rgba(0, 0, 0, 0.05)' }, border: { color: 'rgba(0, 0, 0, 0.08)'} }, y: { ticks: { color: '#6c757d', font: {size: 10} }, grid: { color: 'rgba(0, 0, 0, 0.05)' }, border: { color: 'rgba(0, 0, 0, 0.08)'} } }, plugins: { legend: { labels: { color: '#343a40', font: { size: 11, weight: 600 }, boxWidth: 15, padding: 15 } }, tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', titleColor: '#fff', bodyColor: '#fff', borderColor: 'rgba(0, 0, 0, 0.1)', borderWidth: 1, padding: 8, boxPadding: 4 } } }; const colorFilteredVoltage = '#198754', colorRawVoltage = '#0d6efd', colorCurrent = '#ffc107', colorPower = '#dc3545', colorSoC = '#6f42c1', colorTemp = '#fd7e14', colorHumidity = '#0dcaf0'; const defaultLineOptions = { fill: true, tension: 0.3, borderWidth: 1.8, pointRadius: 0, pointHoverRadius: 4 }; Object.values(charts).forEach(chart => chart?.destroy()); charts.voltage = new Chart(ui.voltageChartCanvas, { type: 'line', data: { datasets: [ { label: 'Filtered (V)', data: [], borderColor: colorFilteredVoltage, backgroundColor: 'rgba(25, 135, 84, 0.08)', ...defaultLineOptions }, { label: 'Raw (V)', data: [], borderColor: colorRawVoltage, backgroundColor: 'rgba(13, 110, 253, 0.08)', tension: 0.1, borderWidth: 1.5, pointRadius: 0 } ]}, options: chartOptions }); charts.power = new Chart(ui.powerChartCanvas, { type: 'line', data: { datasets: [ { label: 'Current (mA)', data: [], borderColor: colorCurrent, backgroundColor: 'rgba(255, 193, 7, 0.08)', yAxisID: 'y', ...defaultLineOptions }, { label: 'Power (W)', data: [], borderColor: colorPower, backgroundColor: 'rgba(220, 53, 69, 0.08)', yAxisID: 'y1', ...defaultLineOptions } ]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, position: 'left', title: { display: true, text: 'Current (mA)', color: '#6c757d', font: {size: 10} } }, y1: { ...chartOptions.scales.y, position: 'right', title: { display: true, text: 'Power (W)', color: '#6c757d', font: {size: 10} }, grid: { drawOnChartArea: false } } }} }); charts.soc = new Chart(ui.socChartCanvas, { type: 'line', data: { datasets: [{ label: 'State of Charge (%)', data: [], borderColor: colorSoC, backgroundColor: 'rgba(111, 66, 193, 0.08)', ...defaultLineOptions }]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } } }); charts.env = new Chart(ui.envChartCanvas, { type: 'line', data: { datasets: [ { label: 'Temperature (¬∞C)', data: [], borderColor: colorTemp, backgroundColor: 'rgba(253, 126, 20, 0.08)', yAxisID: 'y', ...defaultLineOptions }, { label: 'Humidity (%)', data: [], borderColor: colorHumidity, backgroundColor: 'rgba(13, 202, 240, 0.08)', yAxisID: 'y1', ...defaultLineOptions } ]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, position: 'left', title: { display: true, text: 'Temp (¬∞C)', color: '#6c757d', font: {size: 10} } }, y1: { ...chartOptions.scales.y, position: 'right', title: { display: true, text: 'Humidity (%)', color: '#6c757d', font: {size: 10} }, grid: { drawOnChartArea: false } } }} }); console.log('‚úÖ Charts initialized'); }
        async function fetchData() { if (isUpdating) return; isUpdating = true; console.log(`\nüîÑ [${new Date().toLocaleTimeString()}] FETCHING DATA...`); let fetchSuccessful = false; try { const timeRange = getTimeRangeQuery(); if (!timeRange) { isUpdating = false; return; } let currentInterval = '5s'; if (['15m', '30m'].includes(currentTimeRange)) { currentInterval = '15s'; } else if (['1h', '3h'].includes(currentTimeRange)) { currentInterval = '1m'; } else if (['6h', '12h', '24h'].includes(currentTimeRange)) { currentInterval = '5m'; } else if (['7d'].includes(currentTimeRange) || currentTimeRange === 'custom') { currentInterval = '15m'; } aggregateInterval = currentInterval; let requiresAggregation = !!aggregateInterval; let fluxQuery = ` from(bucket: "${config.bucket}") |> ${timeRange} |> filter(fn: (r) => r["_measurement"] == "ncr18650b_power_data") |> filter(fn: (r) => r["battery_type"] == "NCR18650B_1s3p") |> filter(fn: (r) => r["_field"] == "voltage_filtered" or r["_field"] == "voltage_raw" or r["_field"] == "current_ma" or r["_field"] == "power_w" or r["_field"] == "soc_percent" or r["_field"] == "ambient_temp_c" or r["_field"] == "ambient_humidity_percent" or r["_field"] == "bad_readings_total" or r["_field"] == "is_charging" or r["_field"] == "is_discharging") `; if (requiresAggregation) { fluxQuery += `|> aggregateWindow(every: ${aggregateInterval}, fn: mean, createEmpty: false) `; } else { fluxQuery += `|> sort(columns: ["_time"], desc: false) `; } console.log("Using aggregate interval:", aggregateInterval || "Raw"); const response = await fetch(`${config.url}/api/v2/query?org=${encodeURIComponent(config.org)}`, { method: 'POST', headers: { 'Authorization': `Token ${config.token}`, 'Content-Type': 'application/vnd.flux', 'Accept': 'application/csv' }, body: fluxQuery }); if (!response.ok) { const errorBody = await response.text(); console.error("InfluxDB Error Body:", errorBody); throw new Error(`HTTP ${response.status}: ${errorBody}`); } const csv = await response.text(); processData(csv, requiresAggregation); fetchSuccessful = true; clearError(); } catch (error) { console.error('‚ùå Fetch error:', error); if (error.message.includes('HTTP 413') || error.message.includes('request too large')) { showError('Data request too large. Try a shorter time range.'); } else if (error.message.includes('HTTP 401') || error.message.includes('unauthorized')) { showError('Authentication failed. Please check the API Token.'); } else { showError(`Connection error: ${error.message.substring(0, 100)}...`); } } finally { updateStatus(fetchSuccessful); isUpdating = false; } }
        function processData(csv, isAggregated) { console.log(`üìä PROCESSING DATA... (Aggregated: ${isAggregated})`); const lines = csv.trim().split('\n'); const timeSeries = { voltage_filtered: [], voltage_raw: [], current_ma: [], power_w: [], soc_percent: [], ambient_temp_c: [], ambient_humidity_percent: [] }; const latestValues = {}; let totalPoints = 0; rawDataCache = []; for (let i = 0; i < lines.length; i++) { const line = lines[i].trim(); if (!line || line.startsWith('#') || (line.includes('_time') && line.includes('_value') && line.includes('_field'))) continue; const parts = line.split(','); if (parts.length < 8) continue; const timeStr = parts[5]?.trim(), valueStr = parts[6]?.trim(), field = parts[7]?.trim(); if (!timeStr || !valueStr || !field) continue; const time = new Date(timeStr), value = parseFloat(valueStr); if (isNaN(time.getTime()) || isNaN(value)) continue; rawDataCache.push({ timestamp: time.toISOString(), field: field, value: value }); if (timeSeries.hasOwnProperty(field)) { timeSeries[field].push({ x: time, y: value }); totalPoints++; } latestValues[field] = value; } console.log(`üì¶ Parsed ${totalPoints} data points`); console.log(`üìù Latest values:`, latestValues); forceUpdateValue(ui.voltageFiltered, 'card-voltage-filtered', latestValues['voltage_filtered'], 3, 'V'); forceUpdateValue(ui.voltageRaw, 'card-voltage-raw', latestValues['voltage_raw'], 3, 'V'); forceUpdateValue(ui.current, 'card-current', latestValues['current_ma'], 0, 'mA'); forceUpdateValue(ui.power, 'card-power', latestValues['power_w'], 2, 'W'); forceUpdateValue(ui.soc, 'card-soc', latestValues['soc_percent'], 1, '%'); forceUpdateValue(ui.temp, 'card-temp', latestValues['ambient_temp_c'], 1, '¬∞C'); forceUpdateValue(ui.humidity, 'card-humidity', latestValues['ambient_humidity_percent'], 0, '%'); forceUpdateValue(ui.badReadings, 'card-bad', latestValues['bad_readings_total'], 0, ''); const badReadingsCount = latestValues['bad_readings_total'] !== undefined ? Math.round(latestValues['bad_readings_total']) : 0; const goodReadingsCount = totalPoints > 0 ? Math.max(0, totalPoints - badReadingsCount) : 0; forceUpdateValue(ui.goodReadings, 'card-good', goodReadingsCount, 0, ''); let status = 'IDLE', statusClass = 'status-idle'; if (latestValues['is_charging'] !== undefined && Math.round(latestValues['is_charging']) === 1) { status = 'CHARGING'; statusClass = 'status-charging'; } else if (latestValues['is_discharging'] !== undefined && Math.round(latestValues['is_discharging']) === 1) { status = 'DISCHARGING'; statusClass = 'status-discharging'; } if (ui.status) { ui.status.textContent = status; ui.status.className = statusClass; flashCard('card-status'); } updateCounter++; ui.updateCountSpan.textContent = updateCounter; ui.dataPoints.textContent = totalPoints; if(charts.voltage) { charts.voltage.data.datasets[0].data = timeSeries.voltage_filtered; charts.voltage.data.datasets[1].data = timeSeries.voltage_raw; charts.voltage.update('none'); } if(charts.power) { charts.power.data.datasets[0].data = timeSeries.current_ma; charts.power.data.datasets[1].data = timeSeries.power_w; charts.power.update('none'); } if(charts.soc) { charts.soc.data.datasets[0].data = timeSeries.soc_percent; charts.soc.update('none'); } if(charts.env) { charts.env.data.datasets[0].data = timeSeries.ambient_temp_c; charts.env.data.datasets[1].data = timeSeries.ambient_humidity_percent; charts.env.update('none'); } console.log(`‚úÖ UPDATE COMPLETE! Counter: ${updateCounter}`); }
        function forceUpdateValue(element, cardId, value, decimals, unit) { if (!element) { console.warn(`Element for card ${cardId} NOT FOUND!`); return; } const formattedValue = (value !== undefined && value !== null && !isNaN(value)) ? Number(value).toFixed(decimals) : '--'; element.textContent = formattedValue; const unitEl = element.nextElementSibling; if (unitEl && unitEl.classList.contains('metric-unit')) { unitEl.textContent = unit; } else { console.warn(`Unit element not found for ${element.id}`); element.textContent = formattedValue + (unit || ''); } flashCard(cardId); } function flashCard(cardId) { const card = document.getElementById(cardId); if (card) { card.classList.remove('flash'); void card.offsetWidth; card.classList.add('flash'); setTimeout(() => { card.classList.remove('flash'); }, 550); } }
        function updateStatus(connected) { if (!ui.statusBadge || !ui.statusText || !ui.liveDot || !ui.lastUpdate) return; if (connected) { ui.statusBadge.className = 'status-badge status-connected'; ui.statusText.textContent = 'Connected'; ui.liveDot.style.display = 'inline-block'; ui.lastUpdate.textContent = new Date().toLocaleTimeString(); } else { ui.statusBadge.className = 'status-badge status-disconnected'; ui.statusText.textContent = 'Disconnected'; ui.liveDot.style.display = 'none'; ui.lastUpdate.textContent = 'Connection lost'; } } let errorTimeout, successTimeout; function showError(message) { clearTimeout(successTimeout); clearError(); if(ui.errorContainer) ui.errorContainer.innerHTML = `<div class="error-message">${message}</div>`; errorTimeout = setTimeout(clearError, 6000); } function clearError() { clearTimeout(errorTimeout); if(ui.errorContainer) ui.errorContainer.innerHTML = ''; } function showSuccess(message) { clearTimeout(errorTimeout); clearSuccess(); if(ui.successContainer) ui.successContainer.innerHTML = `<div class="success-message">${message}</div>`; successTimeout = setTimeout(clearSuccess, 3500); } function clearSuccess() { clearTimeout(successTimeout); if(ui.successContainer) ui.successContainer.innerHTML = ''; }
        window.addEventListener('beforeunload', () => { if (updateInterval) clearInterval(updateInterval); });
    </script>
</body>
</html>
