<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>CEST VISTEC - Live Battery Monitor</title>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

Â  Â  <style>
Â  Â  Â  Â  /* --- Base & Reset --- */
Â  Â  Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â  Â  html { scroll-behavior: smooth; }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #ffffff; /* Explicitly White */
Â  Â  Â  Â  Â  Â  color: #343a40;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  Â  Â  font-size: 14px; /* Base font size */
Â  Â  Â  Â  }
Â  Â  Â  Â  .container {
Â  Â  Â  Â  Â  Â  max-width: 1300px; /* Slightly reduced max-width */
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  padding: 0 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Header --- */
Â  Â  Â  Â  .header { text-align: center; margin-bottom: 25px; padding: 20px 15px; background-color: #ffffff; border-radius: 6px; border: 1px solid #e9ecef; /* Lighter border */ box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03); }
Â  Â  Â  Â  .header h1 { font-size: 1.8em; margin-bottom: 5px; font-weight: 700; color: #20398c; display: flex; align-items: center; justify-content: center; gap: 8px; }
Â  Â  Â  Â  .header .subtitle { font-size: 0.95em; color: #495057; margin-bottom: 10px; }
Â  Â  Â  Â  .version-badge { display: inline-block; background: #e7f1ff; /* Light blue background */ color: #0d6efd; /* Blue text */ border: 1px solid #cce0ff; padding: 4px 10px; border-radius: 10px; font-weight: 600; font-size: 0.75em; margin-bottom: 12px; }
Â  Â  Â  Â  .company-link { color: #20398c; text-decoration: none; font-size: 0.8em; font-weight: 600; transition: color 0.2s ease; }
Â  Â  Â  Â  .company-link:hover { color: #1a2f70; text-decoration: underline; }

Â  Â  Â  Â  /* --- Status Bar --- */
Â  Â  Â  Â  .status-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
Â  Â  Â  Â  .status-badge { padding: 5px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; display: flex; align-items: center; gap: 5px; background-color: #f8f9fa; border: 1px solid #dee2e6; color: #495057; }
Â  Â  Â  Â  .status-connected { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc;}
Â  Â  Â  Â  .status-disconnected { background-color: #f8d7da; color: #842029; border-color: #f5c2c7;}
Â  Â  Â  Â  .live-dot { display: inline-block; width: 6px; height: 6px; background: #198754; border-radius: 50%; animation: pulse 1.8s infinite ease-in-out; }
Â  Â  Â  Â  .status-disconnected .live-dot { display: none; }
Â  Â  Â  Â  @keyframes pulse { 0%, 100% { transform: scale(0.9); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }

Â  Â  Â  Â  /* --- Toolbar --- */
Â  Â  Â  Â  .toolbar { background: #ffffff; border-radius: 6px; padding: 10px 15px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: space-between; border: 1px solid #e9ecef; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
Â  Â  Â  Â  .toolbar-section { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
Â  Â  Â  Â  .toolbar label { color: #495057 !important; font-weight: 600; font-size: 0.8em; margin-bottom: 0; }
Â  Â  Â  Â  .toolbar select, .custom-range input { padding: 5px 8px; border-radius: 4px; border: 1px solid #ced4da; background-color: #ffffff; color: #343a40; font-size: 0.8em; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
Â  Â  Â  Â  .toolbar select { cursor: pointer; }
Â  Â  Â  Â  .toolbar select:focus, .custom-range input:focus { outline: 0; border-color: #86b7fe; box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25); }
Â  Â  Â  Â  .custom-range { display: none; gap: 8px; flex-wrap: wrap; align-items: center; }
Â  Â  Â  Â  .custom-range.active { display: flex; }
Â  Â  Â  Â  .btn { padding: 5px 12px; border: none; border-radius: 4px; font-size: 0.8em; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.1s ease; user-select: none; }
Â  Â  Â  Â  .btn:active { transform: scale(0.98); }
Â  Â  Â  Â  .btn-secondary { background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
Â  Â  Â  Â  .btn-secondary:hover { background-color: #e2e6ea; border-color: #ced4da; }

Â  Â  Â  Â  /* --- Metrics Grid --- */
Â  Â  Â  Â  .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Further reduced min-width */ gap: 10px; margin-bottom: 20px; }
Â  Â  Â  Â  @media (min-width: 1200px) { /* Aim for 5 columns on wide screens */
Â  Â  Â  Â  Â  Â  Â .metrics-grid { grid-template-columns: repeat(5, 1fr); }
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 992px) and (max-width: 1199px) { /* 4 columns on medium-large */
Â  Â  Â  Â  Â  Â  Â .metrics-grid { grid-template-columns: repeat(4, 1fr); }
Â  Â  Â  Â  }
Â  Â  Â  Â  Â @media (min-width: 768px) and (max-width: 991px) { /* 3 columns on tablets */
Â  Â  Â  Â  Â  Â  Â  .metrics-grid { grid-template-columns: repeat(3, 1fr); }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  .metric-card { background: #ffffff; border-radius: 6px; padding: 12px 10px; text-align: center; border: 1px solid #e9ecef; /* Lighter border */ transition: all 0.2s ease; position: relative; overflow: hidden; box-shadow: none; /* Removed shadow for minimalism */ }
Â  Â  Â  Â  .metric-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(32, 57, 140, 0.04), transparent); transition: left 0.5s ease; }
Â  Â  Â  Â  .metric-card.flash::before { left: 100%; }
Â  Â  Â  Â  .metric-card:hover { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05); border-color: #ced4da;}
Â  Â  Â  Â  .metric-label { font-size: 0.65em; color: #6c757d; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.6px; font-weight: 600; }
Â  Â  Â  Â  .metric-value { font-size: 1.5em; font-weight: 700; color: #212529; display: block; min-height: 30px; line-height: 30px; }
Â  Â  Â  Â  .metric-unit { font-size: 0.75em; color: #495057; font-weight: 400; margin-left: 3px; }
Â  Â  Â  Â  .metric-label > span { margin-right: 4px; font-size: 0.9em; opacity: 0.8; }
Â  Â  Â  Â  .status-charging { color: #198754; font-weight: 600; } .status-discharging { color: #ffc107; font-weight: 600; } .status-idle { color: #6c757d; font-weight: 600; }

Â  Â  Â  Â  /* --- Charts Container --- */
Â  Â  Â  Â  .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); /* Smaller min-width */ gap: 15px; margin-bottom: 20px; }
Â  Â  Â  Â  @media (min-width: 992px) { .charts-container { grid-template-columns: repeat(2, 1fr); } }
Â  Â  Â  Â  .chart-card { background: #ffffff; border-radius: 8px; padding: 15px 20px; border: 1px solid #e9ecef; box-shadow: none; /* Removed shadow */ }
Â  Â  Â  Â  .chart-card h3 { margin-bottom: 15px; color: #20398c; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 6px; }
Â  Â  Â  Â  .chart-wrapper { position: relative; height: 260px; /* Reduced height */ }

Â  Â  Â  Â  /* --- Messages --- */
Â  Â  Â  Â  .message-container { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; max-width: 400px; width: 90%; }
Â  Â  Â  Â  .error-message, .success-message { padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; font-weight: 600; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); animation: slideIn 0.3s ease-out; text-align: left; color: white; display: flex; align-items: center; gap: 8px; font-size: 0.85em;}
Â  Â  Â  Â  .error-message::before { content: 'âŒ'; } .success-message::before { content: 'âœ…'; }
Â  Â  Â  Â  .error-message { background-color: #dc3545; border: 1px solid #b02a37; } .success-message { background-color: #198754; border: 1px solid #146c43; }
Â  Â  Â  Â  @keyframes slideIn { from { transform: translateX(-50%) translateY(-50px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

Â  Â  Â  Â  /* --- Debug Panel --- */
Â  Â  Â  Â  .debug-panel { display: none !important; } /* Hide debug panel completely */

Â  Â  Â  Â  /* === MOBILE ADJUSTMENTS (Integrated and Refined) === */
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  body { padding: 5px; font-size: 13px; } /* Slightly smaller base font on mobile */
Â  Â  Â  Â  Â  Â  .container { padding: 0 5px; }
Â  Â  Â  Â  Â  Â  .header { padding: 12px 8px; margin-bottom: 15px; }
Â  Â  Â  Â  Â  Â  .header h1 { font-size: 1.4em; margin-bottom: 4px; gap: 6px;}
Â  Â  Â  Â  Â  Â  .header .subtitle { font-size: 0.85em; margin-bottom: 8px;}
Â  Â  Â  Â  Â  Â  .version-badge { padding: 3px 8px; font-size: 0.7em; margin-bottom: 8px;}
Â  Â  Â  Â  Â  Â  .company-link { font-size: 0.75em; }
Â  Â  Â  Â  Â  Â  .status-bar { margin-bottom: 15px; gap: 6px; }
Â  Â  Â  Â  Â  Â  .status-badge { padding: 4px 10px; font-size: 0.7em; border-radius: 12px;}
Â  Â  Â  Â  Â  Â  .toolbar { padding: 8px; margin-bottom: 15px; flex-direction: column; align-items: stretch; gap: 10px; }
Â  Â  Â  Â  Â  Â  .toolbar-section { justify-content: space-between; gap: 6px;}
Â  Â  Â  Â  Â  Â  .toolbar-section:last-child { justify-content: center; }
Â  Â  Â  Â  Â  Â  .toolbar label, .toolbar select, .toolbar input, .btn { font-size: 0.8em; } /* Increased slightly for touch */
Â  Â  Â  Â  Â  Â  .toolbar select, .toolbar input { padding: 5px 8px;}
Â  Â  Â  Â  Â  Â  .btn { padding: 6px 12px; }
Â  Â  Â  Â  Â  Â  .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 15px; } /* Tighter grid */
Â  Â  Â  Â  Â  Â  .metric-card { padding: 10px 8px; }
Â  Â  Â  Â  Â  Â  .metric-label { font-size: 0.6em; margin-bottom: 2px; letter-spacing: 0.4px;}
Â  Â  Â  Â  Â  Â  .metric-value { font-size: 1.25em; min-height: 26px; line-height: 26px; }
Â  Â  Â  Â  Â  Â  .metric-unit { font-size: 0.7em; margin-left: 2px;}
Â  Â  Â  Â  Â  Â  .charts-container { gap: 10px; margin-bottom: 15px; }
Â  Â  Â  Â  Â  Â  .chart-card { padding: 12px; }
Â  Â  Â  Â  Â  Â  .chart-card h3 { font-size: 0.9em; margin-bottom: 8px; gap: 6px; }
Â  Â  Â  Â  Â  Â  .chart-wrapper { height: 200px; }
Â  Â  Â  Â  Â  Â  Â .message-container { width: 95%; top: 5px;}
Â  Â  Â  Â  Â  Â  Â .error-message, .success-message { font-size: 0.8em; padding: 8px 12px;}
Â  Â  Â  Â  }

Â  Â  Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  Â  Â  Â .header h1 { font-size: 1.25em; }
Â  Â  Â  Â  Â  Â  Â .header .subtitle { font-size: 0.75em; }
Â  Â  Â  Â  Â  Â  Â .metrics-grid { grid-template-columns: repeat(2, 1fr); gap: 6px;} /* Force 2 columns */
Â  Â  Â  Â  Â  Â  Â .metric-value { font-size: 1.15em;}
Â  Â  Â  Â  Â  Â  Â .chart-wrapper { height: 180px; }
Â  Â  Â  Â  Â  Â  Â .status-badge { padding: 3px 8px; font-size: 0.65em;}
Â  Â  Â  Â  Â  Â  Â .toolbar-section { flex-direction: column; align-items: stretch; gap: 5px; }
Â  Â  Â  Â  Â  Â  Â .custom-range { flex-direction: column; align-items: stretch; gap: 4px; }
Â  Â  Â  Â  Â  Â  Â .custom-range label { margin-bottom: 1px; }
Â  Â  Â  Â  Â  Â  Â .custom-range input { width: 100%; }
Â  Â  Â  Â  Â  Â  Â .custom-range button { margin-top: 4px; }
Â  Â  Â  Â  }
Â  Â  Â  Â  Â /* === MOBILE ADJUSTMENTS END === */

Â  Â  </style>
</head>
<body>
Â  Â  <div class="message-container"> <div id="errorContainer"></div> <div id="successContainer"></div> </div>

Â  Â  <div class="container">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  Â  <h1><span style="font-size: 1em;">â˜€ï¸</span> Solar Light Field Test Monitoring</h1>
Â  Â  Â  Â  Â  Â  <p class="subtitle">Real-time CEST Battery Monitoring</p>
Â  Â  Â  Â  Â  Â  <div class="version-badge"> LIVE DATA </div><br>
Â  Â  Â  Â  Â  Â  <a href="https://www.cestvistec.com/" class="company-link" target="_blank" rel="noopener noreferrer"> ğŸŒ CEST VISTEC - Battery Technology Solutions </a>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="status-bar"> <div id="statusBadge" class="status-badge status-disconnected"> <span id="liveDot" class="live-dot"></span> <span id="statusText">Connecting...</span> </div> <div class="status-badge status-info"> <span>Last Update:</span>&nbsp;<span id="lastUpdate">Waiting...</span> </div> <div class="status-badge status-info"> <span>Points:</span>&nbsp;<span id="dataPoints">0</span> </div> </div>
Â  Â  Â  Â  Â <div id="toolbar" class="toolbar"> <div class="toolbar-section"> <label for="timeRangeSelect">Time Range:</label> <select id="timeRangeSelect" onchange="handleTimeRangeChange()"> <option value="5m">Last 5 Min</option> <option value="15m">Last 15 Min</option> <option value="30m">Last 30 Min</option> <option value="1h">Last 1 Hour</option> <option value="3h">Last 3 Hours</option> <option value="6h">Last 6 Hours</option> <option value="12h">Last 12 Hours</option> <option value="24h">Last 24 Hours</option> <option value="7d">Last 7 Days</option> <option value="custom">Custom</option> </select> <div id="customRange" class="custom-range"> <label for="startTime">From:</label> <input type="datetime-local" id="startTime"> <label for="endTime">To:</label> <input type="datetime-local" id="endTime"> <button class="btn btn-secondary" onclick="applyCustomRange()">Apply</button> </div> </div> <div class="toolbar-section"> <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ Refresh</button> </div> </div>
Â  Â  Â  Â  Â <div id="metricsGrid" class="metrics-grid"> <div class="metric-card" id="card-voltage-filtered"> <div class="metric-label"><span>ğŸ”‹</span> Voltage (Filtered)</div> <div class="metric-value"> <span id="voltageFiltered">--</span><span class="metric-unit">V</span> </div> </div> <div class="metric-card" id="card-voltage-raw"> <div class="metric-label"><span>ğŸ“Š</span> Voltage (Raw)</div> <div class="metric-value"> <span id="voltageRaw">--</span><span class="metric-unit">V</span> </div> </div> <div class="metric-card" id="card-current"> <div class="metric-label"><span>âš¡</span> Current</div> <div class="metric-value"> <span id="current">--</span><span class="metric-unit">mA</span> </div> </div> <div class="metric-card" id="card-power"> <div class="metric-label"><span>ğŸ’ª</span> Power</div> <div class="metric-value"> <span id="power">--</span><span class="metric-unit">W</span> </div> </div> <div class="metric-card" id="card-soc"> <div class="metric-label"><span>ğŸ”‹</span> State of Charge</div> <div class="metric-value"> <span id="soc">--</span><span class="metric-unit">%</span> </div> </div> <div class="metric-card" id="card-temp"> <div class="metric-label"><span>ğŸŒ¡ï¸</span> Temperature</div> <div class="metric-value"> <span id="temp">--</span><span class="metric-unit">Â°C</span> </div> </div> <div class="metric-card" id="card-humidity"> <div class="metric-label"><span>ğŸ’§</span> Humidity</div> <div class="metric-value"> <span id="humidity">--</span><span class="metric-unit">%</span> </div> </div> <div class="metric-card" id="card-status"> <div class="metric-label"><span>ğŸ“ˆ</span> Status</div> <div class="metric-value"> <span id="status">IDLE</span> </div> </div> <div class="metric-card" id="card-good"> <div class="metric-label"><span>âœ…</span> Good Readings</div> <div class="metric-value"> <span id="goodReadings">--</span> </div> </div> <div class="metric-card" id="card-bad"> <div class="metric-label"><span>âŒ</span> Bad Readings</div> <div class="metric-value"> <span id="badReadings">--</span> </div> </div> </div>
Â  Â  Â  Â  Â <div id="chartsContainer" class="charts-container"> <div class="chart-card"> <h3>ğŸ“Š Voltage Monitoring</h3> <div class="chart-wrapper"> <canvas id="voltageChart"></canvas> </div> </div> <div class="chart-card"> <h3>âš¡ Current & Power</h3> <div class="chart-wrapper"> <canvas id="powerChart"></canvas> </div> </div> <div class="chart-card"> <h3>ğŸ”‹ State of Charge</h3> <div class="chart-wrapper"> <canvas id="socChart"></canvas> </div> </div> <div class="chart-card"> <h3>ğŸŒ¡ï¸ Environmental Conditions</h3> <div class="chart-wrapper"> <canvas id="envChart"></canvas> </div> </div> </div>

Â  Â  Â  Â  <div id="debugInfo" class="debug-panel"></div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- GLOBAL VARIABLES ---
Â  Â  Â  Â  const config = { url: "https://us-east-1-1.aws.cloud2.influxdata.com", token: "fRjbZpkh28B7HIaqHyR4A62Jr2bGwiC8Hcc-LwaCUxtKojBMH39CscUEuqp9PTDuqab_3yEfFGtCtsdCYD52Fw==", org: "060e7983bb6be38e", bucket: "solar_bucket" };
Â  Â  Â  Â  let updateInterval = null, charts = {}, currentTimeRange = '5m', rawDataCache = [], isUpdating = false /* updateCounter removed */;
Â  Â  Â  Â  let aggregateInterval = '5s';
Â  Â  Â  Â  const ui = {};

Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  console.log('ğŸš€ CEST VISTEC Battery Monitor - Minimal v1.5 (fn:last + spanGaps)');
Â  Â  Â  Â  Â  Â  cacheDOMElements();
Â  Â  Â  Â  Â  Â  startMonitoring();
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Cache UI Elements ---
Â  Â  Â  Â  function cacheDOMElements() {
Â  Â  Â  Â  Â  Â  ui.statusBadge = document.getElementById('statusBadge'); ui.statusText = document.getElementById('statusText'); ui.liveDot = document.getElementById('liveDot'); ui.lastUpdate = document.getElementById('lastUpdate'); ui.dataPoints = document.getElementById('dataPoints'); ui.errorContainer = document.getElementById('errorContainer'); ui.successContainer = document.getElementById('successContainer'); ui.timeRangeSelect = document.getElementById('timeRangeSelect'); ui.customRangeDiv = document.getElementById('customRange'); ui.startTimeInput = document.getElementById('startTime'); ui.endTimeInput = document.getElementById('endTime'); /* ui.updateCountSpan removed */
Â  Â  Â  Â  Â  Â  ui.voltageFiltered = document.getElementById('voltageFiltered'); ui.voltageRaw = document.getElementById('voltageRaw'); ui.current = document.getElementById('current'); ui.power = document.getElementById('power'); ui.soc = document.getElementById('soc'); ui.temp = document.getElementById('temp'); ui.humidity = document.getElementById('humidity'); ui.status = document.getElementById('status'); ui.goodReadings = document.getElementById('goodReadings'); ui.badReadings = document.getElementById('badReadings');
Â  Â  Â  Â  Â  Â  ui.voltageChartCanvas = document.getElementById('voltageChart'); ui.powerChartCanvas = document.getElementById('powerChart'); ui.socChartCanvas = document.getElementById('socChart'); ui.envChartCanvas = document.getElementById('envChart');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- START MONITORING ---
Â  Â  Â  Â  function startMonitoring() { initCharts(); fetchData(); if (updateInterval) clearInterval(updateInterval); updateInterval = setInterval(() => { if (!isUpdating) fetchData(); }, 3000); console.log('âœ… Monitoring started - refreshing every 3 seconds'); }

Â  Â  Â  Â  // --- TIME RANGE FUNCTIONS --- (Unchanged)
Â  Â  Â  Â  function handleTimeRangeChange() { currentTimeRange = ui.timeRangeSelect.value; if (currentTimeRange === 'custom') { ui.customRangeDiv.classList.add('active'); const now = new Date(), oneHourAgo = new Date(now - 3600000); ui.endTimeInput.value = formatDateTimeLocal(now); ui.startTimeInput.value = formatDateTimeLocal(oneHourAgo); } else { ui.customRangeDiv.classList.remove('active'); fetchData(); } } function applyCustomRange() { fetchData(); } function formatDateTimeLocal(date) { const pad = (n) => String(n).padStart(2, '0'); return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`; } function getTimeRangeQuery() { if (currentTimeRange === 'custom') { const start = ui.startTimeInput.value, end = ui.endTimeInput.value; if (!start || !end) { showError('Select start and end times'); return null; } return `range(start: ${new Date(start).toISOString()}, stop: ${new Date(end).toISOString()})`; } else { return `range(start: -${currentTimeRange})`; } } function refreshData() { clearError(); clearSuccess(); fetchData(); showSuccess('Data refreshed'); }

Â  Â  Â  Â  // --- CHART INITIALIZATION (Minimalist) ---
Â  Â  Â  Â  function initCharts() {
Â  Â  Â  Â  Â  Â  Â // Shared options with grid lines REMOVED
Â  Â  Â  Â  Â  Â  const chartOptions = {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true, maintainAspectRatio: false, animation: false,
Â  Â  Â  Â  Â  Â  Â  Â  interaction: { mode: 'index', intersect: false },
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm', hour: 'MMM dd HH:mm', day: 'MMM dd' } },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#6c757d', maxTicksLimit: 8, font: {size: 9} }, // Fewer ticks, smaller font
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { display: false }, // Remove X grid lines
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: { color: '#dee2e6'} // Light border for axis line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#6c757d', font: {size: 9}, maxTicksLimit: 6 }, // Fewer ticks, smaller font
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { display: false }, // Remove Y grid lines
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  border: { display: false }, // Remove Y axis line itself
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grace: '5%' // Add a little space above/below data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Specific axis for multi-axis charts
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y1: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â position: 'right',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ticks: { color: '#6c757d', font: {size: 9}, maxTicksLimit: 6 },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â grid: { display: false }, // No grid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â border: { display: false }, // No axis line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â grace: '5%'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: { labels: { color: '#343a40', font: { size: 10, weight: 600 }, boxWidth: 12, padding: 10 } }, // Smaller legend
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.75)', titleColor: '#fff', bodyColor: '#fff', borderColor: 'rgba(0, 0, 0, 0.1)', borderWidth: 1, padding: 6, boxPadding: 3, titleFont: { size: 11 }, bodyFont: { size: 10 } } // Compact tooltip
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const colorFilteredVoltage = '#198754', colorRawVoltage = '#0d6efd', colorCurrent = '#ffc107', colorPower = '#dc3545', colorSoC = '#6f42c1', colorTemp = '#fd7e14', colorHumidity = '#0dcaf0';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- [EDIT] Added spanGaps: true ---
Â  Â  Â  Â  Â  Â  // Thinner lines, less fill opacity, and span gaps
Â  Â  Â  Â  Â  Â  const defaultLineOptions = { 
Â  Â  Â  Â  Â  Â  Â  Â  fill: true, 
Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.3, 
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1.5, 
Â  Â  Â  Â  Â  Â  Â  Â  pointRadius: 0, 
Â  Â  Â  Â  Â  Â  Â  Â  pointHoverRadius: 3, 
Â  Â  Â  Â  Â  Â  Â  Â  pointHitRadius: 5, 
Â  Â  Â  Â  Â  Â  Â  Â  spanGaps: true // This tells Chart.js to draw a line over 'null' data points
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  // --- [END EDIT] ---

Â  Â  Â  Â  Â  Â  Object.values(charts).forEach(chart => chart?.destroy());

Â  Â  Â  Â  Â  Â  charts.voltage = new Chart(ui.voltageChartCanvas, { type: 'line', data: { datasets: [ { label: 'Filtered (V)', data: [], borderColor: colorFilteredVoltage, backgroundColor: 'rgba(25, 135, 84, 0.05)', ...defaultLineOptions }, { label: 'Raw (V)', data: [], borderColor: colorRawVoltage, backgroundColor: 'rgba(13, 110, 253, 0.05)', tension: 0.1, borderWidth: 1.2, pointRadius: 0, spanGaps: true } ]}, options: chartOptions });
Â  Â  Â  Â  Â  Â  charts.power = new Chart(ui.powerChartCanvas, { type: 'line', data: { datasets: [ { label: 'Current (mA)', data: [], borderColor: colorCurrent, backgroundColor: 'rgba(255, 193, 7, 0.05)', yAxisID: 'y', ...defaultLineOptions }, { label: 'Power (W)', data: [], borderColor: colorPower, backgroundColor: 'rgba(220, 53, 69, 0.05)', yAxisID: 'y1', ...defaultLineOptions } ]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, position: 'left', title: { display: false } }, y1: { ...chartOptions.scales.y1, position: 'right', title: { display: false } } }} }); // Removed axis titles for minimalism
Â  Â  Â  Â  Â  Â  charts.soc = new Chart(ui.socChartCanvas, { type: 'line', data: { datasets: [{ label: 'State of Charge (%)', data: [], borderColor: colorSoC, backgroundColor: 'rgba(111, 66, 193, 0.05)', ...defaultLineOptions }]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, min: 0, max: 100 } } } });
Â  Â  Â  Â  Â  Â  charts.env = new Chart(ui.envChartCanvas, { type: 'line', data: { datasets: [ { label: 'Temperature (Â°C)', data: [], borderColor: colorTemp, backgroundColor: 'rgba(253, 126, 20, 0.05)', yAxisID: 'y', ...defaultLineOptions }, { label: 'Humidity (%)', data: [], borderColor: colorHumidity, backgroundColor: 'rgba(13, 202, 240, 0.05)', yAxisID: 'y1', ...defaultLineOptions } ]}, options: { ...chartOptions, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, position: 'left', title: { display: false } }, y1: { ...chartOptions.scales.y1, position: 'right', title: { display: false } } }} }); // Removed axis titles
Â  Â  Â  Â  Â  Â  console.log('âœ… Charts initialized (Minimalist + spanGaps)');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- [EDIT] DATA FETCHING (Using fn: last for Aggregation) ---
Â  Â  Â  Â  async function fetchData() {
Â  Â  Â  Â  Â  Â  if (isUpdating) return; isUpdating = true; console.log(`\nğŸ”„ [${new Date().toLocaleTimeString()}] FETCHING DATA...`);
Â  Â  Â  Â  Â  Â  let fetchSuccessful = false;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const timeRange = getTimeRangeQuery(); if (!timeRange) { isUpdating = false; return; }

Â  Â  Â  Â  Â  Â  Â  Â  // --- Determine aggregation interval ---
Â  Â  Â  Â  Â  Â  Â  Â  let currentInterval = '5s'; // Default interval
Â  Â  Â  Â  Â  Â  Â  Â  if (['15m', '30m'].includes(currentTimeRange)) { currentInterval = '15s'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (['1h', '3h'].includes(currentTimeRange)) { currentInterval = '1m'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (['6h', '12h', '24h'].includes(currentTimeRange)) { currentInterval = '5m'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (['7d'].includes(currentTimeRange) || currentTimeRange === 'custom') { currentInterval = '15m'; }
Â  Â  Â  Â  Â  Â  Â  Â  // Optional: Disable aggregation for very short ranges like 5m?
Â  Â  Â  Â  Â  Â  Â  Â  // if (['5m'].includes(currentTimeRange)) { currentInterval = ''; } // Uncomment to see raw data for 5m

Â  Â  Â  Â  Â  Â  Â  Â  aggregateInterval = currentInterval; // Update global var
Â  Â  Â  Â  Â  Â  Â  Â  let requiresAggregation = !!aggregateInterval;

Â  Â  Â  Â  Â  Â  Â  Â  // --- Build Query ---
Â  Â  Â  Â  Â  Â  Â  Â  let fluxQuery = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  from(bucket: "${config.bucket}")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â    |> ${timeRange}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â    |> filter(fn: (r) => r["_measurement"] == "ncr18650b_power_data")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â    |> filter(fn: (r) => r["battery_type"] == "NCR18650B_1s3p")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â    |> filter(fn: (r) =>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "voltage_filtered" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "voltage_raw" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "current_ma" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "power_w" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "soc_percent" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "ambient_temp_c" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "ambient_humidity_percent" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "bad_readings_total" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "is_charging" or
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r["_field"] == "is_discharging"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   )
Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  Â  Â  Â  Â  Â  Â  if (requiresAggregation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // *** Use fn: last instead of fn: mean ***
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fluxQuery += `|> aggregateWindow(every: ${aggregateInterval}, fn: last, createEmpty: false) `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Using aggregate interval: ${aggregateInterval} (fn: last)`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fluxQuery += `|> sort(columns: ["_time"], desc: false) `; // Sort only if not aggregating
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Using aggregate interval: Raw");
Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${config.url}/api/v2/query?org=${encodeURIComponent(config.org)}`, { method: 'POST', headers: { 'Authorization': `Token ${config.token}`, 'Content-Type': 'application/vnd.flux', 'Accept': 'application/csv' }, body: fluxQuery });
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) { const errorBody = await response.text(); console.error("InfluxDB Error Body:", errorBody); throw new Error(`HTTP ${response.status}: ${errorBody}`); }
Â  Â  Â  Â  Â  Â  Â  Â  const csv = await response.text();

Â  Â  Â  Â  Â  Â  Â  Â  processData(csv, requiresAggregation); // processData doesn't need changes for this
Â  Â  Â  Â  Â  Â  Â  Â  fetchSuccessful = true;
Â  Â  Â  Â  Â  Â  Â  t Â  clearError();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('âŒ Fetch error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  if (error.message.includes('HTTP 413') || error.message.includes('request too large')) { showError('Data request too large. Try a shorter time range.'); }
Â  Â  Â  Â  Â  Â  Â  Â  else if (error.message.includes('HTTP 401') || error.message.includes('unauthorized')) { showError('Authentication failed. Please check the API Token.'); }
Â  Â  Â  Â  Â  Â  Â  Â  Â // Catch 503 error specifically
Â  Â  Â  Â  Â  Â  Â  Â  Â else if (error.message.includes('HTTP 503') || error.message.includes('unavailable') || error.message.includes('timeout')) { showError('Connection timeout. Server might be unavailable or network issue.'); }
Â  Â  Â  Â  Â  Â  Â  Â  else { showError(`Connection error: ${error.message.substring(0, 100)}...`); }
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(fetchSuccessful); // Update status based on success flag
Â  Â  Â  Â  Â  Â  Â  Â  isUpdating = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- [END EDIT] ---

Â  Â  Â  Â  // --- DATA PROCESSING --- (updateCounter removed)
Â  Â  Â  Â  function processData(csv, isAggregated) { 
Â  Â  Â  Â  Â  Â  console.log(`ğŸ“Š PROCESSING DATA... (Aggregated: ${isAggregated})`); 
Â  Â  Â  Â  Â  Â  const lines = csv.trim().split('\n'); 
Â  Â  Â  Â  Â  Â  const timeSeries = { voltage_filtered: [], voltage_raw: [], current_ma: [], power_w: [], soc_percent: [], ambient_temp_c: [], ambient_humidity_percent: [] }; 
Â  Â  Â  Â  Â  Â  const latestValues = {}; 
Â  Â  Â  Â  Â  Â  let totalPoints = 0; 
Â  Â  Â  Â  Â  Â  rawDataCache = []; 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < lines.length; i++) { 
Â  Â  Â  Â  Â  Â  Â  Â  const line = lines[i].trim(); 
Â  Â  Â  Â  Â  Â  Â  Â  if (!line || line.startsWith('#') || (line.includes('_time') && line.includes('_value') && line.includes('_field'))) continue; 
Â  Â  Â  Â  Â  Â  Â  Â  const parts = line.split(','); 
Â  Â  Â  Â  Â  Â  Â  Â  if (parts.length < 8) continue; 
Â  Â  Â  Â  Â  Â  Â  Â  const timeStr = parts[5]?.trim(), valueStr = parts[6]?.trim(), field = parts[7]?.trim(); 
Â  Â  Â  Â  Â  Â  Â  Â  if (!timeStr || !valueStr || !field) continue; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const time = new Date(timeStr), value = parseFloat(valueStr); 
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(time.getTime()) || isNaN(value)) continue; 

Â  Â  Â  Â  Â  Â  Â  Â  // --- [EDIT] Treat 0 as 'null' for specific chart fields to create gaps ---
Â  Â  Â  Â  Â  Â  Â  Â  let chartValue = value;
Â  Â  Â  Â  Â  Â  Â  Â  // Only do this for fields where 0 is an error/reset, not a valid measurement (like current)
Â  Â  Â  Â  Â  Â  Â  Â  if ((field === 'voltage_filtered' || field === 'voltage_raw' || field === 'soc_percent') && value === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chartValue = null; // This will be spanned by 'spanGaps: true'
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // --- [END EDIT] ---

Â  Â  Â  Â  Â  Â  Â  Â  rawDataCache.push({ timestamp: time.toISOString(), field: field, value: value }); // Still cache the raw '0' value
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (timeSeries.hasOwnProperty(field)) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timeSeries[field].push({ x: time, y: chartValue }); // Use chartValue for the graph
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalPoints++; 
Â  Â  Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  Â  Â  latestValues[field] = value; // Use the original 'value' for metric cards
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  console.log(`ğŸ“¦ Parsed ${totalPoints} data points`); 
Â  Â  Â  Â  Â  Â  console.log(`ğŸ“ Latest values:`, latestValues); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Update UI
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.voltageFiltered, 'card-voltage-filtered', latestValues['voltage_filtered'], 3, 'V'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.voltageRaw, 'card-voltage-raw', latestValues['voltage_raw'], 3, 'V'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.current, 'card-current', latestValues['current_ma'], 0, 'mA'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.power, 'card-power', latestValues['power_w'], 2, 'W'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.soc, 'card-soc', latestValues['soc_percent'], 1, '%'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.temp, 'card-temp', latestValues['ambient_temp_c'], 1, 'Â°C'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.humidity, 'card-humidity', latestValues['ambient_humidity_percent'], 0, '%'); 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.badReadings, 'card-bad', latestValues['bad_readings_total'], 0, ''); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const badReadingsCount = latestValues['bad_readings_total'] !== undefined ? Math.round(latestValues['bad_readings_total']) : 0; 
Â  Â  Â  Â  Â  Â  const goodReadingsCount = totalPoints > 0 ? Math.max(0, totalPoints - badReadingsCount) : 0; 
Â  Â  Â  Â  Â  Â  forceUpdateValue(ui.goodReadings, 'card-good', goodReadingsCount, 0, ''); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let status = 'IDLE', statusClass = 'status-idle'; 
Â  Â  Â  Â  Â  Â  if (latestValues['is_charging'] !== undefined && Math.round(latestValues['is_charging']) === 1) { status = 'CHARGING'; statusClass = 'status-charging'; } 
Â  Â  Â  Â  Â  Â  else if (latestValues['is_discharging'] !== undefined && Math.round(latestValues['is_discharging']) === 1) { status = 'DISCHARGING'; statusClass = 'status-discharging'; } 
Â  Â  Â  Â  Â  Â  if (ui.status) { ui.status.textContent = status; ui.status.className = statusClass; flashCard('card-status'); } 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  ui.dataPoints.textContent = totalPoints; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Update Charts
Â  Â  Â  Â  Â  Â  if(charts.voltage) { charts.voltage.data.datasets[0].data = timeSeries.voltage_filtered; charts.voltage.data.datasets[1].data = timeSeries.voltage_raw; charts.voltage.update('none'); } 
Â  Â  Â  Â  Â  Â  if(charts.power) { charts.power.data.datasets[0].data = timeSeries.current_ma; charts.power.data.datasets[1].data = timeSeries.power_w; charts.power.update('none'); } 
Â  Â  Â  Â  Â  Â  if(charts.soc) { charts.soc.data.datasets[0].data = timeSeries.soc_percent; charts.soc.update('none'); } 
Â  Â  Â  Â  Â  Â  if(charts.env) { charts.env.data.datasets[0].data = timeSeries.ambient_temp_c; charts.env.data.datasets[1].data = timeSeries.ambient_humidity_percent; charts.env.update('none'); } 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  console.log(`âœ… UPDATE COMPLETE!`); 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FORCE UPDATE VALUE & FLASH --- (Unchanged)
Â  Â  Â  Â  function forceUpdateValue(element, cardId, value, decimals, unit) { if (!element) { console.warn(`Element for card ${cardId} NOT FOUND!`); return; } const formattedValue = (value !== undefined && value !== null && !isNaN(value)) ? Number(value).toFixed(decimals) : '--'; element.textContent = formattedValue; const unitEl = element.nextElementSibling; if (unitEl && unitEl.classList.contains('metric-unit')) { unitEl.textContent = unit; } else { console.warn(`Unit element not found for ${element.id}`); element.textContent = formattedValue + (unit || ''); } flashCard(cardId); } function flashCard(cardId) { const card = document.getElementById(cardId); if (card) { card.classList.remove('flash'); void card.offsetWidth; card.classList.add('flash'); setTimeout(() => { card.classList.remove('flash'); }, 550); } }

Â  Â  Â  Â  // --- STATUS & MESSAGES --- (Unchanged)
Â  Â  Â  Â  function updateStatus(connected) { if (!ui.statusBadge || !ui.statusText || !ui.liveDot || !ui.lastUpdate) return; if (connected) { ui.statusBadge.className = 'status-badge status-connected'; ui.statusText.textContent = 'Connected'; ui.liveDot.style.display = 'inline-block'; ui.lastUpdate.textContent = new Date().toLocaleTimeString(); } else { ui.statusBadge.className = 'status-badge status-disconnected'; ui.statusText.textContent = 'Disconnected'; ui.liveDot.style.display = 'none'; ui.lastUpdate.textContent = 'Connection lost'; } } let errorTimeout, successTimeout; function showError(message) { clearTimeout(successTimeout); clearError(); if(ui.errorContainer) ui.errorContainer.innerHTML = `<div class="error-message">${message}</div>`; errorTimeout = setTimeout(clearError, 6000); } function clearError() { clearTimeout(errorTimeout); if(ui.errorContainer) ui.errorContainer.innerHTML = ''; } function showSuccess(message) { clearTimeout(errorTimeout); clearSuccess(); if(ui.successContainer) ui.successContainer.innerHTML = `<div class="success-message">${message}</div>`; successTimeout = setTimeout(clearSuccess, 3500); } function clearSuccess() { clearTimeout(successTimeout); if(ui.successContainer) ui.successContainer.innerHTML = ''; }

Â  Â  Â  Â  // --- Cleanup --- (Unchanged)
Â  Â  Â  Â  window.addEventListener('beforeunload', () => { if (updateInterval) clearInterval(updateInterval); });
Â  Â  </script>
</body>
</html>
