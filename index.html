<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCR18650B Monitor - VOLTAGE FLUCTUATION FIX v3.1</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
            animation: versionPulse 2s infinite;
        }
        
        @keyframes versionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .company-link {
            color: #60a5fa;
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.3s;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .status-badge {
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .status-connected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .status-disconnected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .status-info {
            background: rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .live-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.4; 
                transform: scale(0.8);
            }
        }
        
        .update-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.2em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: counterBounce 0.5s ease-out;
        }
        
        @keyframes counterBounce {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .config-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .config-panel h3 {
            margin-bottom: 20px;
            color: #60a5fa;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .toolbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toolbar-section {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .toolbar select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        .custom-range {
            display: none;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .custom-range.active {
            display: flex;
        }
        
        .custom-range input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .metric-card.flash::before {
            left: 100%;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .metric-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
            display: block;
            min-height: 50px;
            line-height: 50px;
        }
        
        .metric-unit {
            font-size: 20px;
            color: #94a3b8;
            font-weight: 400;
            margin-left: 5px;
        }
        
        .status-charging {
            color: #10b981;
        }
        
        .status-discharging {
            color: #fbbf24;
        }
        
        .status-idle {
            color: #94a3b8;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #60a5fa;
            font-size: 18px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .message-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }
        
        .error-message, .success-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            text-align: center;
        }
        
        .error-message {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .success-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .debug-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .metric-value {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="updateCounter" class="update-counter">
        Updates: <span id="updateCount">0</span>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>⚡ NCR18650B Battery Monitor</h1>
            <div class="version-badge">
                🔥 VERSION 3.1 - VOLTAGE FLUCTUATION FIX! 🔥
            </div>
            <p style="margin-top: 10px; font-size: 1.1em;">Real-Time Battery Pack Monitoring System</p>
            <p style="margin-top: 5px; font-size: 0.9em; color: #f59e0b;">
                <strong>NOW HANDLES ALL VOLTAGE LEVELS!</strong> No more freezing during voltage drops!
            </p>
            <a href="https://www.cestvistec.com/" class="company-link" target="_blank">
                🌐 CESTVISTEC - Battery Technology Solutions
            </a>
        </div>
        
        <div class="status-bar">
            <div id="statusBadge" class="status-badge status-disconnected">
                <span id="liveDot" class="live-dot" style="display: none;"></span>
                <span id="statusText">Not Connected</span>
            </div>
            <div class="status-badge status-info">
                <span id="lastUpdate">Waiting for data...</span>
            </div>
            <div class="status-badge status-info">
                <span id="dataPoints">Points: 0</span>
            </div>
        </div>
        
        <div class="message-container">
            <div id="errorContainer"></div>
            <div id="successContainer"></div>
        </div>
        
        <div id="configPanel" class="config-panel">
            <h3>📡 InfluxDB Configuration</h3>
            <p style="margin-bottom: 20px; color: #94a3b8;">Enter your InfluxDB credentials to start monitoring</p>
            
            <div class="form-group">
                <label>InfluxDB URL</label>
                <input type="text" id="influxUrl" placeholder="https://your-influxdb-url.com">
            </div>
            
            <div class="form-group">
                <label>API Token</label>
                <input type="password" id="influxToken" placeholder="Your InfluxDB API token">
            </div>
            
            <div class="form-group">
                <label>Organization</label>
                <input type="text" id="influxOrg" placeholder="your-org">
            </div>
            
            <div class="form-group">
                <label>Bucket</label>
                <input type="text" id="influxBucket" placeholder="your-bucket">
            </div>
            
            <div class="form-group checkbox-group">
                <input type="checkbox" id="debugMode">
                <label for="debugMode" style="margin-bottom: 0;">Enable Debug Mode (Shows ALL data parsing)</label>
            </div>
            
            <button class="btn btn-primary" onclick="saveConfig()">
                🚀 Start Monitoring
            </button>
        </div>
        
        <div id="toolbar" class="toolbar" style="display: none;">
            <div class="toolbar-section">
                <label style="color: #94a3b8; font-weight: 600;">Time Range:</label>
                <select id="timeRangeSelect" onchange="handleTimeRangeChange()">
                    <option value="5m">Last 5 Minutes</option>
                    <option value="15m">Last 15 Minutes</option>
                    <option value="30m">Last 30 Minutes</option>
                    <option value="1h">Last 1 Hour</option>
                    <option value="3h">Last 3 Hours</option>
                    <option value="6h">Last 6 Hours</option>
                    <option value="12h">Last 12 Hours</option>
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
                
                <div id="customRange" class="custom-range">
                    <label style="color: #94a3b8;">From:</label>
                    <input type="datetime-local" id="startTime">
                    <label style="color: #94a3b8;">To:</label>
                    <input type="datetime-local" id="endTime">
                    <button class="btn btn-secondary" onclick="applyCustomRange()">Apply</button>
                </div>
            </div>
            
            <div class="toolbar-section">
                <button class="btn btn-secondary" onclick="refreshData()">🔄 Refresh</button>
                <button class="btn btn-secondary" onclick="exportCSV()">📊 Export CSV</button>
                <button class="btn btn-secondary" onclick="exportJSON()">💾 Export JSON</button>
            </div>
        </div>
        
        <div id="metricsGrid" class="metrics-grid" style="display: none;">
            <div class="metric-card" id="card-voltage-filtered">
                <div class="metric-label">🔋 Voltage (Filtered)</div>
                <div class="metric-value">
                    <span id="voltageFiltered">--</span>
                    <span class="metric-unit">V</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-voltage-raw">
                <div class="metric-label">📊 Voltage (Raw)</div>
                <div class="metric-value">
                    <span id="voltageRaw">--</span>
                    <span class="metric-unit">V</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-current">
                <div class="metric-label">⚡ Current</div>
                <div class="metric-value">
                    <span id="current">--</span>
                    <span class="metric-unit">mA</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-power">
                <div class="metric-label">💪 Power</div>
                <div class="metric-value">
                    <span id="power">--</span>
                    <span class="metric-unit">W</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-soc">
                <div class="metric-label">🔋 State of Charge</div>
                <div class="metric-value">
                    <span id="soc">--</span>
                    <span class="metric-unit">%</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-temp">
                <div class="metric-label">🌡️ Temperature</div>
                <div class="metric-value">
                    <span id="temp">--</span>
                    <span class="metric-unit">°C</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-humidity">
                <div class="metric-label">💧 Humidity</div>
                <div class="metric-value">
                    <span id="humidity">--</span>
                    <span class="metric-unit">%</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-status">
                <div class="metric-label">📈 Status</div>
                <div class="metric-value">
                    <span id="status">IDLE</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-good">
                <div class="metric-label">✅ Good Readings</div>
                <div class="metric-value">
                    <span id="goodReadings">--</span>
                </div>
            </div>
            
            <div class="metric-card" id="card-bad">
                <div class="metric-label">❌ Bad Readings</div>
                <div class="metric-value">
                    <span id="badReadings">--</span>
                </div>
            </div>
        </div>
        
        <div id="chartsContainer" class="charts-container" style="display: none;">
            <div class="chart-card">
                <h3>📊 Voltage Monitoring</h3>
                <div class="chart-wrapper">
                    <canvas id="voltageChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>⚡ Current & Power</h3>
                <div class="chart-wrapper">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>🔋 State of Charge</h3>
                <div class="chart-wrapper">
                    <canvas id="socChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>🌡️ Environmental Conditions</h3>
                <div class="chart-wrapper">
                    <canvas id="envChart"></canvas>
                </div>
            </div>
        </div>
        
        <div id="debugInfo" class="debug-panel"></div>
    </div>
    
    <script>
        let config = { url: '', token: '', org: '', bucket: '' };
        let updateInterval = null;
        let charts = {};
        let debugMode = false;
        let currentTimeRange = '5m';
        let rawDataCache = [];
        let isUpdating = false;
        let updateCounter = 0;
        
        window.addEventListener('load', () => {
            console.log('🚀 ========================================');
            console.log('🚀 NCR18650B Battery Monitor v3.1');
            console.log('🚀 VOLTAGE FLUCTUATION FIX');
            console.log('🚀 Handles ALL voltage levels including drops!');
            console.log('🚀 ========================================');
            
            const saved = localStorage.getItem('influxConfig');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                    document.getElementById('influxUrl').value = config.url || '';
                    document.getElementById('influxToken').value = config.token || '';
                    document.getElementById('influxOrg').value = config.org || '';
                    document.getElementById('influxBucket').value = config.bucket || '';
                    
                    if (config.url && config.token && config.org && config.bucket) {
                        startMonitoring();
                    }
                } catch (e) {
                    console.error('Error loading saved config:', e);
                }
            }
        });
        
        function saveConfig() {
            config.url = document.getElementById('influxUrl').value.trim();
            config.token = document.getElementById('influxToken').value.trim();
            config.org = document.getElementById('influxOrg').value.trim();
            config.bucket = document.getElementById('influxBucket').value.trim();
            debugMode = document.getElementById('debugMode').checked;
            
            if (!config.url || !config.token || !config.org || !config.bucket) {
                showError('Please fill in all required fields');
                return;
            }
            
            try {
                new URL(config.url);
            } catch (e) {
                showError('Invalid InfluxDB URL format');
                return;
            }
            
            localStorage.setItem('influxConfig', JSON.stringify(config));
            showSuccess('Configuration saved successfully');
            startMonitoring();
        }
        
        function startMonitoring() {
            document.getElementById('configPanel').style.display = 'none';
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('metricsGrid').style.display = 'grid';
            document.getElementById('chartsContainer').style.display = 'grid';
            
            if (debugMode) {
                document.getElementById('debugInfo').style.display = 'block';
            }
            
            initCharts();
            fetchData();
            
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                if (!isUpdating) fetchData();
            }, 2000);
            
            console.log('✅ Monitoring started - updates every 2 seconds');
        }
        
        function handleTimeRangeChange() {
            const select = document.getElementById('timeRangeSelect');
            currentTimeRange = select.value;
            
            if (currentTimeRange === 'custom') {
                document.getElementById('customRange').classList.add('active');
                const now = new Date();
                const oneHourAgo = new Date(now - 60 * 60 * 1000);
                document.getElementById('endTime').value = formatDateTimeLocal(now);
                document.getElementById('startTime').value = formatDateTimeLocal(oneHourAgo);
            } else {
                document.getElementById('customRange').classList.remove('active');
                fetchData();
            }
        }
        
        function applyCustomRange() {
            fetchData();
        }
        
        function formatDateTimeLocal(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
        
        function getTimeRangeQuery() {
            if (currentTimeRange === 'custom') {
                const start = document.getElementById('startTime').value;
                const end = document.getElementById('endTime').value;
                
                if (!start || !end) {
                    showError('Please select both start and end times');
                    return null;
                }
                
                return `range(start: ${new Date(start).toISOString()}, stop: ${new Date(end).toISOString()})`;
            } else {
                return `range(start: -${currentTimeRange})`;
            }
        }
        
        function refreshData() {
            clearError();
            clearSuccess();
            fetchData();
            showSuccess('Data refreshed successfully');
        }
        
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'MMM dd HH:mm',
                                day: 'MMM dd'
                            }
                        },
                        ticks: { color: '#94a3b8', maxTicksLimit: 10 },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    },
                    y: {
                        ticks: { color: '#94a3b8' },
                        grid: { color: 'rgba(148, 163, 184, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { 
                            color: '#fff',
                            font: { size: 12, weight: 600 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1
                    }
                }
            };
            
            charts.voltage = new Chart(document.getElementById('voltageChart'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Filtered (V)',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Raw (V)',
                            data: [],
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            fill: true,
                            tension: 0.1,
                            borderWidth: 1
                        }
                    ]
                },
                options: chartOptions
            });
            
            charts.power = new Chart(document.getElementById('powerChart'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Current (mA)',
                            data: [],
                            borderColor: '#fbbf24',
                            yAxisID: 'y',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Power (W)',
                            data: [],
                            borderColor: '#f87171',
                            yAxisID: 'y1',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            position: 'left',
                            title: { display: true, text: 'Current (mA)', color: '#94a3b8' }
                        },
                        y1: {
                            ...chartOptions.scales.y,
                            position: 'right',
                            title: { display: true, text: 'Power (W)', color: '#94a3b8' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            
            charts.soc = new Chart(document.getElementById('socChart'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'State of Charge (%)',
                        data: [],
                        borderColor: '#a78bfa',
                        backgroundColor: 'rgba(167, 139, 250, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, min: 0, max: 100 }
                    }
                }
            });
            
            charts.env = new Chart(document.getElementById('envChart'), {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: [],
                            borderColor: '#f87171',
                            yAxisID: 'y',
                            tension: 0.4,
                            borderWidth: 2
                        },
                        {
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: '#60a5fa',
                            yAxisID: 'y1',
                            tension: 0.4,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            position: 'left',
                            title: { display: true, text: 'Temp (°C)', color: '#94a3b8' }
                        },
                        y1: {
                            ...chartOptions.scales.y,
                            position: 'right',
                            title: { display: true, text: 'Humidity (%)', color: '#94a3b8' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            
            console.log('✅ Charts initialized');
        }
        
        async function fetchData() {
            if (isUpdating) {
                console.log('⏳ Update in progress, skipping...');
                return;
            }
            
            isUpdating = true;
            console.log(`\n🔄 [${new Date().toLocaleTimeString()}] FETCHING DATA...`);
            
            try {
                const timeRange = getTimeRangeQuery();
                if (!timeRange) {
                    isUpdating = false;
                    return;
                }
                
                const query = `
from(bucket: "${config.bucket}")
  |> ${timeRange}
  |> filter(fn: (r) => r["_measurement"] == "ncr18650b_power_data")
  |> filter(fn: (r) => 
    r["_field"] == "voltage_filtered" or 
    r["_field"] == "voltage_raw" or 
    r["_field"] == "current_ma" or 
    r["_field"] == "power_w" or 
    r["_field"] == "soc_percent" or
    r["_field"] == "ambient_temp_c" or
    r["_field"] == "ambient_humidity_percent" or
    r["_field"] == "bad_readings_total" or
    r["_field"] == "is_charging" or
    r["_field"] == "is_discharging"
  )
  |> sort(columns: ["_time"], desc: false)
`;
                
                const response = await fetch(`${config.url}/api/v2/query?org=${encodeURIComponent(config.org)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${config.token}`,
                        'Content-Type': 'application/vnd.flux',
                        'Accept': 'application/csv'
                    },
                    body: query
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const csv = await response.text();
                processData(csv);
                updateStatus(true);
                clearError();
                
            } catch (error) {
                console.error('❌ Fetch error:', error);
                updateStatus(false);
                showError(`Connection failed: ${error.message}`);
            } finally {
                isUpdating = false;
            }
        }
        
        // CRITICAL FIX: This function now accepts ALL values without filtering
        function processData(csv) {
            console.log(`📊 PROCESSING DATA (NO FILTERING - ACCEPTS ALL VALUES!)...`);
            const lines = csv.trim().split('\n');
            
            const timeSeries = {
                voltage_filtered: [],
                voltage_raw: [],
                current_ma: [],
                power_w: [],
                soc_percent: [],
                ambient_temp_c: [],
                ambient_humidity_percent: []
            };
            
            const latestValues = {};
            let totalPoints = 0;
            rawDataCache = [];
            
            let parseErrors = 0;
            
            // Parse CSV with NO VALUE FILTERING
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line || line.startsWith('#')) continue;
                if (line.includes('_time') && line.includes('_value') && line.includes('_field')) continue;
                
                const parts = line.split(',');
                if (parts.length < 8) {
                    if (debugMode) console.log(`⚠️  Line ${i}: Not enough columns (${parts.length})`);
                    continue;
                }
                
                const timeStr = parts[5]?.trim();
                const valueStr = parts[6]?.trim();
                const field = parts[7]?.trim();
                
                if (!timeStr || !valueStr || !field) {
                    if (debugMode) console.log(`⚠️  Line ${i}: Missing data`);
                    continue;
                }
                
                const time = new Date(timeStr);
                const value = parseFloat(valueStr);
                
                // CRITICAL: Accept ALL numeric values, even if they seem "wrong"
                if (isNaN(time.getTime())) {
                    if (debugMode) console.log(`⚠️  Line ${i}: Invalid time: ${timeStr}`);
                    parseErrors++;
                    continue;
                }
                
                if (isNaN(value)) {
                    if (debugMode) console.log(`⚠️  Line ${i}: Invalid value: ${valueStr} for field ${field}`);
                    parseErrors++;
                    continue;
                }
                
                // NO FILTERING - Accept all values including negative, zero, extreme values
                if (debugMode && (value < 0 || value > 5 && field.includes('voltage'))) {
                    console.log(`📌 Unusual value accepted: ${field} = ${value}`);
                }
                
                rawDataCache.push({
                    timestamp: time.toISOString(),
                    field: field,
                    value: value
                });
                
                if (timeSeries.hasOwnProperty(field)) {
                    timeSeries[field].push({ x: time, y: value });
                    totalPoints++;
                }
                
                // ALWAYS update to latest value, regardless of what it is
                latestValues[field] = value;
            }
            
            console.log(`📦 Parsed ${totalPoints} data points (${parseErrors} parse errors)`);
            console.log(`📝 Latest values (ALL ACCEPTED):`, latestValues);
            
            if (debugMode) {
                let debugInfo = `
📊 Update #${updateCounter + 1} at ${new Date().toLocaleTimeString()}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Parsed Points: ${totalPoints}
Parse Errors: ${parseErrors}
Time Range: ${currentTimeRange}
Cache Size: ${rawDataCache.length} entries
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Latest Values (RAW - NO FILTERING):
${JSON.stringify(latestValues, null, 2)}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Last 5 data points:
`;
                rawDataCache.slice(-5).forEach(item => {
                    debugInfo += `${item.timestamp} | ${item.field} = ${item.value}\n`;
                });
                
                document.getElementById('debugInfo').textContent = debugInfo;
            }
            
            // UPDATE ALL VALUES - NO EXCEPTIONS
            console.log(`🎯 FORCE UPDATING ALL VALUES (even unusual ones)...`);
            
            forceUpdateValue('voltageFiltered', 'card-voltage-filtered', latestValues['voltage_filtered'], 3, ' V');
            forceUpdateValue('voltageRaw', 'card-voltage-raw', latestValues['voltage_raw'], 3, ' V');
            forceUpdateValue('current', 'card-current', latestValues['current_ma'], 0, ' mA');
            forceUpdateValue('power', 'card-power', latestValues['power_w'], 2, ' W');
            forceUpdateValue('soc', 'card-soc', latestValues['soc_percent'], 1, ' %');
            forceUpdateValue('temp', 'card-temp', latestValues['ambient_temp_c'], 1, ' °C');
            forceUpdateValue('humidity', 'card-humidity', latestValues['ambient_humidity_percent'], 0, ' %');
            forceUpdateValue('badReadings', 'card-bad', latestValues['bad_readings_total'], 0, '');
            
            const expectedReadings = Math.floor((Date.now() - new Date(rawDataCache[0]?.timestamp || Date.now())) / 1000);
            const goodReadings = expectedReadings - (latestValues['bad_readings_total'] || 0);
            forceUpdateValue('goodReadings', 'card-good', goodReadings > 0 ? goodReadings : 0, 0, '');
            
            let status = 'IDLE';
            let statusClass = 'status-idle';
            if (latestValues['is_charging'] === 1) {
                status = 'CHARGING';
                statusClass = 'status-charging';
            }
            if (latestValues['is_discharging'] === 1) {
                status = 'DISCHARGING';
                statusClass = 'status-discharging';
            }
            
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = status;
                statusEl.className = statusClass;
                flashCard('card-status');
            }
            
            updateCounter++;
            document.getElementById('updateCount').textContent = updateCounter;
            document.getElementById('updateCounter').style.animation = 'none';
            setTimeout(() => {
                document.getElementById('updateCounter').style.animation = 'counterBounce 0.5s ease-out';
            }, 10);
            
            document.getElementById('dataPoints').textContent = `Points: ${totalPoints}`;
            
            charts.voltage.data.datasets[0].data = timeSeries.voltage_filtered;
            charts.voltage.data.datasets[1].data = timeSeries.voltage_raw;
            charts.voltage.update('none');
            
            charts.power.data.datasets[0].data = timeSeries.current_ma;
            charts.power.data.datasets[1].data = timeSeries.power_w;
            charts.power.update('none');
            
            charts.soc.data.datasets[0].data = timeSeries.soc_percent;
            charts.soc.update('none');
            
            charts.env.data.datasets[0].data = timeSeries.ambient_temp_c;
            charts.env.data.datasets[1].data = timeSeries.ambient_humidity_percent;
            charts.env.update('none');
            
            console.log(`✅ UPDATE COMPLETE! Counter: ${updateCounter} | V_filtered=${latestValues['voltage_filtered']?.toFixed(3)}V | V_raw=${latestValues['voltage_raw']?.toFixed(3)}V | I=${latestValues['current_ma']?.toFixed(0)}mA`);
        }
        
        function forceUpdateValue(elementId, cardId, value, decimals, unit) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`   ⚠️  Element ${elementId} NOT FOUND!`);
                return;
            }
            
            // Accept undefined/null and show as "--", but accept ALL numeric values including 0, negative, extreme
            let formattedValue;
            if (value === undefined || value === null) {
                formattedValue = '--';
            } else if (typeof value === 'number') {
                formattedValue = value.toFixed(decimals);
            } else {
                formattedValue = String(value);
            }
            
            element.textContent = formattedValue + unit;
            
            console.log(`   ✓ ${elementId} = ${formattedValue}${unit}`);
            
            flashCard(cardId);
        }
        
        function flashCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.remove('flash');
                void card.offsetWidth;
                card.classList.add('flash');
                setTimeout(() => card.classList.remove('flash'), 600);
            }
        }
        
        function exportCSV() {
            if (rawDataCache.length === 0) {
                showError('No data available to export');
                return;
            }
            
            const grouped = {};
            rawDataCache.forEach(item => {
                if (!grouped[item.timestamp]) {
                    grouped[item.timestamp] = { timestamp: item.timestamp };
                }
                grouped[item.timestamp][item.field] = item.value;
            });
            
            const rows = Object.values(grouped);
            const headers = ['timestamp', 'voltage_filtered', 'voltage_raw', 'current_ma', 'power_w', 
                            'soc_percent', 'ambient_temp_c', 'ambient_humidity_percent', 
                            'bad_readings_total', 'is_charging', 'is_discharging'];
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
            });
            
            downloadFile(csv, `ncr18650b_data_${currentTimeRange}_${Date.now()}.csv`, 'text/csv');
            showSuccess(`Exported ${rows.length} rows to CSV`);
        }
        
        function exportJSON() {
            if (rawDataCache.length === 0) {
                showError('No data available to export');
                return;
            }
            
            const exportData = {
                device: 'NCR18650B_POWER_MONITOR_003',
                location: 'Thailand_Rayong_NCR18650B',
                company: 'CESTVISTEC',
                timeRange: currentTimeRange,
                exportedAt: new Date().toISOString(),
                dataPoints: rawDataCache.length,
                data: rawDataCache
            };
            
            const json = JSON.stringify(exportData, null, 2);
            downloadFile(json, `ncr18650b_data_${currentTimeRange}_${Date.now()}.json`, 'application/json');
            showSuccess(`Exported ${rawDataCache.length} data points to JSON`);
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function updateStatus(connected) {
            const badge = document.getElementById('statusBadge');
            const text = document.getElementById('statusText');
            const dot = document.getElementById('liveDot');
            const lastUpdate = document.getElementById('lastUpdate');
            
            if (connected) {
                badge.className = 'status-badge status-connected';
                text.textContent = '🟢 Connected';
                dot.style.display = 'inline-block';
                lastUpdate.textContent = '🕐 Last: ' + new Date().toLocaleTimeString();
            } else {
                badge.className = 'status-badge status-disconnected';
                text.textContent = '🔴 Disconnected';
                dot.style.display = 'none';
                lastUpdate.textContent = '⚠️ Connection lost';
            }
        }
        
        function showError(message) {
            document.getElementById('errorContainer').innerHTML = 
                `<div class="error-message">❌ ${message}</div>`;
            setTimeout(clearError, 5000);
        }
        
        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }
        
        function showSuccess(message) {
            document.getElementById('successContainer').innerHTML = 
                `<div class="success-message">✅ ${message}</div>`;
            setTimeout(clearSuccess, 3000);
        }
        
        function clearSuccess() {
            document.getElementById('successContainer').innerHTML = '';
        }
        
        window.addEventListener('beforeunload', () => {
            if (updateInterval) clearInterval(updateInterval);
        });
        
        console.log('🎯 v3.1 VOLTAGE FLUCTUATION FIX - Ready!');
        console.log('💪 Now accepts ALL voltage levels - no more freezing!');
    </script>
</body>
</html>
